name: "Maven MuleSoft CloudHub 2.0 Deployment Workflow"

on:
  push:
    branches:
      - main

run-name: "Deploy Mule App | Commit: ${{ github.event.head_commit.message }} | Triggered by: ${{ github.actor }}"

jobs:
  Initialize:
    runs-on: ubuntu-latest
    outputs:
      build-id: ${{ steps.generate-id.outputs.build_id }}
    steps:
      - name: "Set up Build Context"
        id: generate-id
        run: echo "build_id=build-${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: "Display Workflow Info"
        run: |
          echo " Starting MuleSoft CloudHub 2.0 Deployment..."
          echo "ðŸ”¹ Triggered by: ${{ github.actor }}"
          echo "ðŸ”¹ Commit Message: ${{ github.event.head_commit.message }}"
          echo "ðŸ”¹ Environment: DEV"

  Build-App:
    needs: Initialize
    runs-on: ubuntu-latest
    env:
      JAVA_VERSION: '17'
      MAVEN_VERSION: '3.9.6'
      ENVIRONMENT: 'DEV'
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4

      - name: "Set up Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: "Set up Maven"
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}

      - name: "Cache Maven Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      - name: "Build Mule Application"
        run: mvn -B package --file pom.xml -D"mule.env"="${{ secrets.dev_mule_env }}" -D"mule.key"="${{ secrets.dev_mule_key }}" -DskipTests

      - name: "Upload Build Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: mule-artifacts
          path: target/*.jar
          retention-days: 2

  Publish-To-Exchange:
    needs: Build-App
    runs-on: ubuntu-latest
    env:
      MAVEN_VERSION: '3.9.6'
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Restore Maven Cache"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}

      - name: "Download Built Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: mule-artifacts

      - name: "Set up Maven"
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}

      - name: "Publish to Anypoint Exchange"
        env:
          connectedAppId: ${{ secrets.connected_app_id }}
          connectedAppSecret: ${{ secrets.connected_app_secret }}
        run: mvn deploy --settings settings/settings.xml -DskipTests

  Deploy-To-CloudHub2:
    needs: Publish-To-Exchange
    runs-on: ubuntu-latest
    env:
      JAVA_VERSION: '17'
      MAVEN_VERSION: '3.9.6'
      ENVIRONMENT: 'DEV'
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Restore Maven Cache"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}

      - name: "Download JAR Artifact"
        uses: actions/download-artifact@v4
        with:
          name: mule-artifacts

      - name: "Set up Maven"
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}

      - name: "Deploy to CloudHub 2.0"
        env:
          connectedAppId: ${{ secrets.connected_app_id }}
          connectedAppSecret: ${{ secrets.connected_app_secret }}
          grantType: ${{ secrets.grant_type }}
        run: |
          echo "Deploying Mule App to CloudHub 2.0..."
          mvn clean deploy --settings settings/settings.xml -DskipTests -DmuleDeploy -DjavaVersion="${{ env.JAVA_VERSION }}" -Denvironment="${{ env.ENVIRONMENT }}" -D"mule.env"="${{ secrets.dev_mule_env }}"  -D"application.name"="ci-cd-deploy-poc-geetika" -Dtarget=Cloudhub-US-East-1 -Dreplicas=1 -DvCores="0.1"

  Notify:
    needs: Deploy-To-CloudHub2
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: "Send Deployment Summary"
        run: |
          echo "Mule Application successfully deployed to CloudHub 2.0 Environment: DEV"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.event.head_commit.message }}"
          echo "Workflow Run ID: ${{ github.run_id }}"
